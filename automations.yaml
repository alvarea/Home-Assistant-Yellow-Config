#-----------------------------------------------------------------------------#
#                                                                             #
# HOMY - HOME ASSISTANT - ALVAREA 2020                                        #
#                                                                             #
#-----------------------------------------------------------------------------#
# TEMPLATING JINJA2:  https://jinja.palletsprojects.com/en/master/templates   #
#                                                                             #
#-----------------------------------------------------------------------------#


#-----------------------------------------------------------------------------#
#                                                                             #
# ARRANQUE/PARADA DEL SISTEMA                                                 #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: hass_startup_automation
  alias: hass_startup_scripts
  trigger:
    platform: homeassistant
    # Event can also be 'shutdown'
    event: start
  action:
    # Para todas las reglas durante el arranque del sistema
    #- service: automation.turn_off
    #  data:
    #    entity_id:
    #      - group.all_automations

    # Llamada al script de inicialización de interruptores Sonoff
    - service: script.sonoff_initialize
    #
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople
    #
    # 30" espera y arranca reglas
    #- delay: 30
    #- service: automation.turn_on
    #  data:
    #    entity_id:
    #      - group.all_automations

#-----------------------------------------------------------------------------#
#                                                                             #
# TAREAS PERIODICAS DEL SISTEMA                                               #
#                                                                             #
#-----------------------------------------------------------------------------#
- id: hass_weekly_ha_restart
  alias: 'HA weekly restart'
  trigger:
    - platform: time
      at: '06:00:00'
  condition:
    - condition: time
      weekday: sat
  action:
    # Reinicio HA Core
    - service: homeassistant.restart

- id: hass_daily_automations
  alias: 'HA daily automations'
  trigger:
    - platform: time
      at:
        - '08:00:00'
        - '00:00:00'
  action:
    # Establece Volumnen Alexa Entrada/Estudio/Dormitorio según hora del día/noche
    - service: script.alexa_entrada_set_volumen
    - service: script.alexa_estudio_set_volumen
    - service: script.alexa_dormitorio_set_volumen
    #
    # Establece Volumen Xiaomi Hub => DEPRECATED
    - service: input_number.set_value
      data_template:
        entity_id: input_number.xiaomi_volume_alarm_armed
        value: >-
          {% if (now().hour == 11) %} {{ 10|float}}
          {% elif (now().hour == 23) %} {{ 2|float}}
          {% endif %}
    - service: input_number.set_value
      data_template:
        entity_id: input_number.xiaomi_volume_alarm_disarmed
        value: >-
          {% if (now().hour == 11) %} {{ 10|float}}
          {% elif (now().hour == 23) %} {{ 2|float}}
          {% endif %}

- id: hass_clock_notify
  alias: 'HASS Clock Notify'
  trigger:
    - platform: time
      at:
        - '13:00:00'
        - '13:45:00'
        - '14:30:00'
        - '21:30:00'
  action:
    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        sonido: 'clock_01'
        repeticion: 1
        voz: >
          {% if now().hour == 13 and now().minute == 00 %}
            "Buenos días. Son las {{ now().hour }}, es la hora de un aperitivo"
          {% elif now().hour == 13 and now().minute == 45 %}
            "Buenas tardes. Son las {{ now().hour }} y {{ now().minute }}, es la hora de preparar la comida"
          {% elif now().hour == 14 and now().minute == 30 %}
            "Buenas tardes. Son las {{ now().hour }} y {{ now().minute }}, es la hora del almuerzo"
          {% elif now().hour ==21 %}
            "Buenas noches. Son las {{ now().hour }} y {{ now().minute }}, es la hora de preparar la cena"
          {% endif %}

- id: hass_blink_update
  alias: 'BLINK Camera Update'
  trigger:
    - platform: time_pattern
      hours: "/1"
  condition:
    condition: and
    conditions:
      - condition: sun
        after: sunrise
        before: sunset
        before_offset: "04:00:00"
  action:
    # Actualizacion imagen cámaras última hora.
    - service: script.blink_trigger_cam_hall
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_puerta_principal
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_puerta_garaje
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_piscina
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_porche
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_estudio
    - delay: '00:00:10'
    - service: script.blink_trigger_cam_cocina

#-----------------------------------------------------------------------------#
#                                                                             #
# ALARMA: Armado y Control de la Alarma                                       #
#                                                                             #
#-----------------------------------------------------------------------------#

# REGLAS: TEST SONIDOS ALARMA
#
- id: X0_test
  alias: 'X0 TEST ON'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_test_sirenas
      from: 'off'
      to: 'on'
  action:
    # Micro Aviso Sirena Interior
    - service: script.sirena_alarma_micro_aviso

#
# ALARMA AUTOMATICA SENSOR HUMO COCINA
#
- id: X1_alarma_humo_cocina
  alias: 'X1 Alarma Humo Cocina'
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_humo_cocina
      from: 'off'
      to: 'on'
  action:
    # Micro Aviso Sirena Interior
    - service: script.sirena_alarma_micro_aviso

    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        sonido: "{{ states('input_select.alarma_sonido_disparado') }}"
        repeticion: 1
        voz: 'ATENCION! ¡ALARMA HUMO COCINA!. Sensor Humo Cocina. ¡ATENCION! ¡ALARMA!'

    # Script Notificaciones Alarma
    - service: script.notifica_alarma
      data:
        variables:
          titulo: '*ATENCION ALARMA HUMO*'
          mensaje: >
            >>> URGENTE: SENSOR HUMO COCINA
#
# ALARMA AUTOMATICA SENSOR SENSOR AGUA ARQUETA
#
- id: X2_alarma_agua_arqueta
  alias: 'X1 Alarma Agua Arqueta'
  trigger:
    - platform: state
      entity_id: binary_sensor.water_leak_sensor_158d00045a3376
      from: 'off'
      to: 'on'
  action:
    # Micro Aviso Sirena Interior
    - service: script.sirena_alarma_micro_aviso

    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        sonido: "{{ states('input_select.alarma_sonido_disparado') }}"
        repeticion: 1
        voz: 'ATENCION! ¡ALARMA AGUA ARQUETA!. Sensor Agua Arqueta. ¡ATENCION! ¡ALARMA!'

    # Script Notificación Alarma
    - service: script.notifica_alarma
      data:
        variables:
          titulo: '*ATENCION ALARMA AGUA*'
          mensaje: >
            >>> URGENTE: SENSOR AGUA ARQUETA BAÑO
#
# REGLA: ALARMA DISARMED A <ARMING>
#
- id: A0
  alias: 'A0 Alarma Disarmed to Pending'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'disarmed'
      to: 'arming'
  action:   
    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia_alarma_armado
      data_template:
        voz: "¡ATENCION!, alarma activada. Tiene un minuto para salir. ATENCION!, alarma activada. Salga ahora, por favor."
        sonido: "{{ states('input_select.alarma_sonido_desarmado') }}"
#
# REGLA: ALARMA ARMED A <PENDING>
#
- id: A1
  alias: 'A1 Alarma Armed to Pending'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'armed_home'
      to: 'pending'
    - platform: state
      entity_id: alarm_control_panel.ha
      from: 'armed_away'
      to: 'pending'
  action:
    #- service: script.alarma_to_pending
    #  data_template:
    #    fromstate: '{{trigger.from_state.state}}'
    #    tostate: '{{trigger.to_state.state}}'
    #    ringtone_msg: 10004

    # Script Notifica Evento Alarma Disparada
    - service: script.notifica_evento
      data_template:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: ATENCION AVISO PREVIO SALTO ALARMA

    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia_alarma_desarmado
      data_template:
        voz: "¡ATENCION!, Alarma Disparada. Tiene un minuto para desarmar. ¡ATENCION!, Desarme ahora, por favor."
        sonido: "{{ states('input_select.alarma_sonido_desarmado') }}"

# REGLA: ARMADO AWAY COMPLETADO
#
- id: A2
  alias: 'A2 Alarma Armado Away OK'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'armed_away'
  action:
    # Encendido Led VERDE Tag Reader
    - service: light.turn_on
      entity_id: light.tagreader_led
      data:
        color_name: orange
        transition: 3
        brightness: 128
    # INICIALIZA EL SENSOR DEL TRIGGER
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: " "
    # Aviso sonoro con Xiaomi GW
    #- service: script.sirena_xiaomi_play_alarm_armed

    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        voz: "ATENCION!. Armado Total activado."
        sonido: "{{ states('input_select.alarma_sonido_armado') }}"
        repeticion: 1

    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: ARMADO TOTAL (AWAY)
          >>> ACCION: Apagado Total Casa

    # Llamada a Script Apagado Casa
    - service: script.home_switch_off

    #- delay: 00:01:00
    # ARMADO PANEL ALARMA BLINK
    #- service: alarm_control_panel.alarm_arm_away
    #  entity_id: alarm_control_panel.blink_casa

#
# REGLA: ARMADO HOME COMPLETADO
#
- id: A3
  alias: 'A3 Alarma Armado Home OK'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'armed_home'
  action:
    # Encendido Led Azul Tag Reader
    - service: light.turn_on
      entity_id: light.tagreader_led
      data:
        color_name: blue
        transition: 3
        brightness: 128

    # ALMACENA EL SENSOR DEL TRIGGER
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: " "
    # Aviso sonoro con Xiaomi GW
    #- service: script.sirena_xiaomi_play_alarm_armed

    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        voz: "ATENCION!. Armado parcial activado."
        sonido: "{{ states('input_select.alarma_sonido_armado') }}"
        repeticion: 1

    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: ARMADO PARCIAL (HOME)


    # Revisar
    # https://community.home-assistant.io/t/automation-with-is-state-trigger-to-state-on-not-working/54691/2
    #        >>> MODO: "{{ trigger.to_state.state }}"

#
# REGLA: DESARMADO OK => SIRENA OFF, AVISO Y NOTIFICACION (DISARMED)
#
- id: A4
  alias: 'A4 Alarma Disarmed'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'disarmed'
  action:
    # SONOFF_SW1_SIRENA INTERIOR ==> OFF
    - service: siren.turn_off
      entity_id: siren.sirena

    # DESARMADO PANEL ALARMA BLINK
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.blink_casa

    # Resetea el sensor del TRIGGER
    #- service: input_text.set_value
    #  entity_id: input_text.alarm_trigger
    #  data_template:
    #    value: " "

    # Apaga Luz Piloto Alarma
    - service: light.turn_off
      entity_id: 
        - light.luz_gateway_aqara
        - light.tagreader_led
      
    # Script Envío Sonido Alexa Alexa
    - service: script.alexa_secuencia
      data_template:
        voz: "ATENCION!. Alarma desactivada."
        sonido: "{{ states('input_select.alarma_sonido_desarmado') }}"
        repeticion: 1

    # Script Notificación Evento
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: Alarma Desactivada
#
# REGLA: TRIGGER SENSOR => MODO ARMADO AWAY => PENDING ==> ALARMA TRIGGERED
#
- id: A5
  alias: 'A5 Alarm Trigger Armed Away'
  trigger:
    # MUY IMPORTANTE: EN EL ARM AWAY SE CHEQUEA GRUPO SENSORES HOME + AWAY
    - platform: state
      entity_id:
        - binary_sensor.alarma_sensores_perimetro_principal      # Grupo Sensores PERIMETRO PRINCIPAL
        - binary_sensor.alarma_sensores_perimetro_secundario     # Grupo Sensores PERIMETRO SECUNDARIO
        - binary_sensor.alarma_sensores_presencia_interior       # Grupo Sensores Presencia INTERIOR
        - binary_sensor.alarma_sensores_presencia_exterior       # Grupo Sensores Presencia EXTERIOR
      to: 'on'
    # Los sensores vibración solo saltan por trigger = platform device
    - platform: device
      type: vibration
      device_id: f23111988853a7beeb8c26078f390729 # Puerta Principal Entrada
      entity_id: 3c418e73805f1a07820c181eb7bbe936
      domain: binary_sensor
    - platform: device
      type: vibration
      device_id: b8cd622289394361f35ed30b303598f9 # Puerta Salón
      entity_id: 0a5a7d3964574dd4792fa6f0925a5e3e
      domain: binary_sensor
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.ha
        state: armed_away
  action:
    # ALMACENA EL SENSOR DEL TRIGGER
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: "{{ trigger.to_state.attributes.friendly_name }}"
    #
    # DISPARA LA ALARMA, que pasa a estado PENDING durante 60'
    # Si no se desactiva, pasa a triggered y se envían notificaciones y Sirena
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.ha

#
# REGLA: TRIGGER SENSOR => MODO ARMADO HOME => PENDING ==> ALARMA TRIGGERED
#
- id: A6
  alias: 'A6 Alarm Trigger Armed Home'
  trigger:
    - platform: state
      # Grupo Sensores PERIMETRO
      entity_id: binary_sensor.alarma_sensores_perimetro_principal
      to: 'on'
    # Los sensores vibración solo saltan por trigger = platform device
    - platform: device
      type: vibration
      device_id: f23111988853a7beeb8c26078f390729 # Puerta Principal Entrada
      entity_id: 3c418e73805f1a07820c181eb7bbe936
      domain: binary_sensor
    - platform: device
      type: vibration
      device_id: b8cd622289394361f35ed30b303598f9 # Puerta Salón
      entity_id: 0a5a7d3964574dd4792fa6f0925a5e3e
      domain: binary_sensor
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha
      state: armed_home
  action:
    # ALMACENA EL SENSOR DEL TRIGGER
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: "{{ trigger.to_state.attributes.friendly_name }}"

    # DISPARA LA ALARMA, que pasa a estado PENDING durante 60'
    # Si no se desactiva, pasa a triggered y se envían notificaciones y Sirena
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.ha


# REGLA: ALARMA ARMED_AWAY TRIGGERED ==> SIRENA + NOTIFICACION COMPLETA
#
- id: A7
  alias: 'A7 Alarm Triggered'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha
      to: 'triggered'
  action:
    # Script Notificación Alarma
    - service: script.notifica_alarma
      data_template:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: ATENCION ALARMA DISPARADA

    # ALEXA SIRENAS ALARMA DISPARADA
    - service: script.alexa_secuencia_alarma_disparada

# REGLA: TRIGGER DESARMADO AUTOMATICO AL AMANECER
#
- id: A9
  alias: 'A9 Alarm Home Auto Disarm'
  trigger:
    - platform: sun
      event: sunrise
      offset: "-00:15:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.ha
        state: armed_home
      # Hay alguien en casa
      - condition: state
        entity_id: binary_sensor.family_any_home
        state: 'on'
  action:
    # ALMACENA EL SENSOR DEL TRIGGER
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: "A9 Armed_Home Auto Disarm Sunrise"
    # Desarmado de Alarmas
    - service: alarm_control_panel.alarm_disarm
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code
    # Check sensores perimetro
    - service: script.check_sensores_magneticos_perimetro
    # Aviso sonoro con Xiaomi GW
    - service: script.sirena_stop_alarma
    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*ALARMA HOMY*'
        mensaje: >
          >>> ESTADO: Desarmado automático al amanecer.

#
# REGLA: APAGADO BOTON PANICO
#
- id: A10
  alias: 'A10 Alarm Boton Panico Off'
  trigger:
    platform: state
    entity_id: input_boolean.alarm_panic_button
    from: 'on'
    to: 'off'
  action:
    # Llamada a script desactivado botón pánico.
    - service: script.alarma_boton_panico_off

- id: A11
  alias: 'A11 Check Status Sensores Perimetro Led Tag Reader'
  trigger:
    platform: state
    entity_id: binary_sensor.alarma_check_listo_para_armar
  action:
    - service: light.turn_on
      entity_id: light.tagreader_led
      data_template:
        brightness: 128
        color_name: >
          {% if states.binary_sensor.alarma_check_listo_para_armar.state == 'on' %}
            green
          {% else %}
            red
          {%endif%}

#-----------------------------------------------------------------------------#
#                                                                             #
# FAMILY TRACKING AT HOME: Control Home/Away                                  #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: f01_family_away_armado_total
  alias: 'F01 Family Away Armado Total'
  trigger:
    # Ya no hay nadie en casa
    platform: state
    entity_id: binary_sensor.family_any_home
    from: 'on'
    to: 'off'
  action:
    # Script Activación Alarma ARM AWAY
    - service: script.homy_armado_total
    # Delay para no bloquear notificaciones
    - delay: 0:01
    # Script  Apagado Total
    - service: script.home_switch_off


- id: f02_family_home_armado_home
  alias: 'F02 Family Home Armado Home'
  trigger:
    - platform: template
      value_template: >-
        {{  now().hour >= 1
            and now().hour <= 6
            and now().minute % 15 == 0
        }}
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.ha
        state: disarmed
      - condition: time
        after: '00:45:00'
      - condition: time
        before: '07:00:00'
      - condition: state
        entity_id: binary_sensor.family_any_home
        state: 'on'
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.alarma_check_listo_para_armar
        state: 'on'
      sequence:
        # Notifica Evento
        - service: script.notifica_evento
          data:
            titulo: '*FAMILY HOME*'
            mensaje: >
              >>> MADRUGADA ALGUIEN EN CASA. AUTO ARMADO HOME EN 5' 
        - delay: '00:00:05'
        - service: alarm_control_panel.alarm_arm_home
          entity_id: alarm_control_panel.ha
    # ELIF trigger.id = 1 => SHORT_press - TURN_OFF
    default:
      - service: script.alexa_secuencia
        data_template:
          sonido: 'clock_01'
          repeticion: 1
          voz: Atención. Alarma no lista para armado parcial. Revise puertas y ventanas.
          
- id: F04
  alias: 'F04 Family Home'
  trigger:
    # Hay alguien en casa
    - platform: state
      entity_id: binary_sensor.family_any_home
      from: 'off'
      to: 'on'
  action:
    # Script encendido Luz piloto si es de noche
    - service: script.notifica_evento
      data_template:
        titulo: '*FAMILY HOME: SI*'
        mensaje: >
          >>> EVENTO: Primero en Entrar {{ states('sensor.family_last_tracking') }}

- id: F05
  alias: 'F05 Family Home How Many Sleep'
  trigger:
    # Hay alguien en casa
    - platform: state
      entity_id:
        - input_boolean.family_sleep_home_mfc
        - input_boolean.family_sleep_home_acc
        - input_boolean.family_sleep_home_paf
        - input_boolean.family_sleep_home_aaf
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

- id: F06
  alias: 'F06 Family MFC - Check Sleep'
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.family_home_mfc
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_mfc
        state: 'off'
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

    - service: input_boolean.turn_on
      entity_id: input_boolean.family_sleep_home_mfc
    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*FAMILY HOME*'
        mensaje: >
          >>> Malen está en casa a las 23:00

          >>> Activado el control de Duerme en Casa.

- id: F07
  alias: 'F07 Family AAF - Check Sleep'
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.family_home_aaf
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_aaf
        state: 'off'
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

    - service: input_boolean.turn_on
      entity_id: input_boolean.family_sleep_home_aaf
    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*FAMILY HOME*'
        mensaje: >
          >>> Agu está en casa a las 23:00

          >>> Activado el control de Duerme en Casa.

- id: F08
  alias: 'F08 Family PAF - Check Sleep'
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.family_home_paf
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_paf
        state: 'off'
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

    - service: input_boolean.turn_on
      entity_id: input_boolean.family_sleep_home_paf
    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*FAMILY HOME*'
        mensaje: >
          >>> Paloma está en casa a las 23:00

          >>> Activado el control de Duerme en Casa.

- id: F09
  alias: 'F09 Family AAC - Check Sleep'
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.family_home_aac
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_aac
        state: 'off'
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

    - service: input_boolean.turn_on
      entity_id: input_boolean.family_sleep_home_paf
    # Notifica Evento
    - service: script.notifica_evento
      data:
        titulo: '*FAMILY HOME*'
        mensaje: >
          >>> Agustín está en casa a las 23:00

          >>> Activado el control de Duerme en Casa.

- id: F10
  alias: 'F10 Family Any Change - Actualiza Contador'
  mode: restart
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.family_home_aac
        - binary_sensor.family_home_mfc
        - binary_sensor.family_home_paf
        - binary_sensor.family_home_aaf
  action:
    # Llamada al contador de personas que actualiza sensor.family_home
    - service: python_script.countpeople

- id: F11
  alias: 'F11 Family AAF Not Home'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.family_home_aaf
      to: 'off'
  action:
    # Apara el Area Dormitorio Agu
    - service: switch.turn_off
      data: {}
      target:
        area_id: dormitorio_aaf
    - service: light.turn_off
      data: {}
      target:
        area_id: dormitorio_aaf

- id: F12
  alias: 'F11 Family PAF Not Home'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.family_home_paf
      to: 'off'
  action:
    # Apara el Area Dormitorio Paloma
    - service: switch.turn_off
      data: {}
      target:
        area_id: dormitorio_paf
    - service: light.turn_off
      data: {}
      target:
        area_id: dormitorio_paf



#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE CONTROL DE ESCENAS                                                #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: E01
  alias: 'E01 Escena Estudio Sunrise al Amanecer'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_movimiento_estudio
      to: 'on'
  condition:
    - condition: and
      conditions:
        # Si la fecha de última ejecucion de la escena es diferente a la del día (no se ha ejecutado ese día)
        - condition: template
          value_template: "{{ states('scene.estudio_sunrise') == 'unknown' or 
            states('sensor.date') != (as_timestamp(states('scene.estudio_sunrise')) | timestamp_custom('%Y-%m-%d', True)) }}"
        - condition: sun
          before: sunset
        - condition: sun
          after: sunrise
          after_offset: "-01:00:00"
        - condition: state
          entity_id: binary_sensor.family_home_aac
          state: 'on'
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.estudio_sunrise
    # Alexa Estudio Cadena COPE
    #
    - service: media_player.media_play
      target:
        entity_id: media_player.echo_alexa_estudio

- id: E02
  alias: 'E02 Escena Estudio Sunset al Atardecer'
  mode: restart
  trigger:
    - platform: sun
      event: sunset
      offset: "-00:15:00"
  condition:
    - condition: and
      conditions:
        # Si la fecha de última ejecucion de la escena es diferente a la del día (no se ha ejecutado ese día)
        - condition: template
          value_template: "{{ states('scene.estudio_sunrise') == 'unknown' or 
            states('sensor.date') != (as_timestamp(states('scene.estudio_sunrise')) | timestamp_custom('%Y-%m-%d', True)) }}"
        # Si AAC está en casa
        - condition: state
          entity_id: binary_sensor.family_home_aac
          state: 'on'
        # Algún portátil AAC deben estar encendido
        - condition: state
          entity_id: binary_sensor.laptop_aac
          state: 'on'
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.estudio_sunrise
    - service: media_player.media_pause
      target:
        entity_id: media_player.echo_alexa_estudio

- id: E03
  alias: 'E03 Escena Estudio Sleep'
  mode: restart
  trigger:
    - platform: time
      at:
        - "23:00:00"
        - "00:00:00"
        - "01:00:00"
        - "02:00:00"
        - "03:30:00"
        - "04:00:00"
  condition:
    - condition: and
      conditions:
        # Si la fecha de última ejecucion de la escena es diferente a la del día (no se ha ejecutado ese día)
        - condition: state
          entity_id:
            - cover.persiana_estudio
          state: 'open'
        - condition: template
          value_template: "{{ states('scene.estudio_sleep') == 'unknown' or
            states('sensor.date') != (as_timestamp(states('scene.estudio_sleep')) | timestamp_custom('%Y-%m-%d', True)) }}"
        # Los dos portátiles AAC deben estar apagados
        - condition: state
          entity_id: binary_sensor.laptop_aac
          state: 'off'
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.estudio_sleep
    - service: media_player.media_pause
      target:
        entity_id: media_player.echo_alexa_estudio


#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE CONTROL DE LUCES Y ALUMBRADO                                      #
#                                                                             #
#-----------------------------------------------------------------------------#
- id: L01
  alias: 'L01 Luces On Exterior Sunset'
  trigger:
      # offset: "+00:30:00"   # Horario Invierno GMT+1
      # offset: "+00:10:00"   # Horario Invierno GMT+1 - Febrero
      # offset: "-00:30:00"   # Horario Verano GMT+2
    - platform: sun
      event: sunset
      offset: "+00:10:00"
  action:
    # Encendido Luces Exterior y Jardín
    - service: script.luces_exterior_on
    # Notifica a Familia
    - service: script.notifica_evento
      data:
        voz: 'Se ha puesto el sol. Enciendo luces del jardín'
        titulo: '*ALUMBRADO*'
        mensaje: >
          >>> EVENTO: Puesta de Sol hace 10'

          >>> LUCES: Alumbrado Exterior On

- id: L02
  alias: 'L02 Luces Off Exterior Medianoche'
  # APAGA LAS LUCES DEL JARDIN SI NO ES VERANO
  trigger:
    - platform: time
      at: '23:30:00'
      id: trigger_2330
    - platform: time
      at: '00:30:00'
      id: trigger_0030
  condition:
    condition: or
    conditions:
      - condition: template
        value_template: "{{ now().hour == 23 and states('sensor.season') != 'summer' and states('light.luces_exterior') == 'on' }}"
      - condition: template
        value_template: "{{ now().hour == 00 and states('sensor.season') == 'summer' and states('light.luces_exterior') == 'on' }}"
  action:
    # Apagado Luces Exterior Casa + Luces Jardín
    - service: light.turn_off
      entity_id: light.luces_exterior
    # Notifica a Familia
    - service: script.notifica_evento
      data:
        voz: 'Es  medianoche. Apagando luces Exterior y Jardín'
        titulo: '*ALUMBRADO*'
        mensaje: >
          >>> EVENTO: Es Medianoche

          >>> LUCES: Apagado Alumbrado Exterior + Jardín

- id: L04
  alias: 'L04 Luces On Salon Sunset'
  trigger:
    - platform: sun
      # offset: "-00:35:00"   # Horario Invierno GMT+1
      # offset: "-00:25:00"   # Horario Verano GMT+2
      event: sunset
      offset: "-00:35:00"
  condition:
    condition: and
    conditions:
        # Hay alguien en casa
      - condition: state
        entity_id: binary_sensor.family_any_home
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.aqara_movimiento_salon_luminosidad
        below: 50
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.salon_sunset
      data:
        transition: 30
    # Notifica a Familia
    - service: script.notifica_evento
      data:
        titulo: '*ALUMBRADO*'
        mensaje: >
          >>> EVENTO: Puesta de Sol en breve

          >>> LUCES: Alumbrado Luz Salón On
#
# La regla de alumbrado exterior según sensor se simplifica para que se encienda por la noche, siempre que esté oscuro.
# La idea es que por programacion horaria y puesta de sol la regla de encendido en la puesta de sol encienda y mantenga
# encendida las luces hasta al menos las 23.55.
# A partir de esa hora se apagan las luces y entraria a funcionar esta regla,
# de forma que al pasar alguien por la entrada si está oscuro, encienda los faroles exterior.
# Se elimina la notificación Telegram.
#
- id: L05
  alias: 'L05 Luces On Exterior Segun Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_movimiento_entrada_exterior
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: light.luz_exterior
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.aqara_movimiento_exterior_luminosidad
        below: 10
  action:
    - service: light.turn_on
      entity_id: light.luz_exterior
    - delay: '00:05:00'
    - service: light.turn_off
      entity_id: light.luz_exterior

- id: L06
  alias: 'L06 Luces Off Before Sunrise'
  trigger:
    - platform: time
      at:
        - "01:00:00"
        - "02:00:00"
        - "03:30:00"
        - "04:00:00"
        - "05:00:00"
        - "06:00:00"
        - "07:00:00"
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: light.luces_planta_alta # Luces Planta Alta
        state: 'on'
      - condition: state
        entity_id: light.luces_planta_baja # Luces Planta Baja
        state: 'on'
      - condition: state
        entity_id: light.luces_jardin # Luces exterior
        state: 'on'
  action:
    # Apagado Luces Toda la Casa
    - service: light.turn_off
      entity_id: light.luces_toda_la_casa

- id: L07
  alias: 'L07 Luces On Entrada Según Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_movimiento_entrada
      to: 'on'
    - platform: state
      entity_id: binary_sensor.aqara_puerta_entrada_principal
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ (now().hour >= 0 and now().hour < 11) or (now().hour > 17 and now().hour <= 23) }}"
      - condition: state
        entity_id: light.luz_entrada
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.aqara_movimiento_entrada_luminosidad
        below: 100
  action:
    # Luces Entrada ON
    - service: light.turn_on
      data:
        brightness_pct: >
          {% if now().hour >= 0 and now().hour <= 7 %} 10
          {% elif now().hour >= 8 and now().hour <= 17 %} 40
          {% else %} 50
          {% endif %}
      target:
        entity_id: light.luz_entrada
    # Si Alarm.Armed_Home => Piloto ON
    - service: script.luz_on_armed_home
    # Espera de x minutos en función de la hora
    - delay:
        minutes: >
          {% if now().hour >= 1 and now().hour <= 7 %} 1
          {% else %} 3
          {% endif %}
    # Luces Entrada OFF
    - service: light.turn_off
      entity_id:
        - light.luz_entrada
        - light.luz_gateway_aqara

- id: L08
  alias: 'L08 Luces On Dormitorio Según Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002ea1d0f
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: sun
        after: sunset
        after_offset: "+00:15:00"
      - condition: state
        entity_id: light.luces_dormitorio_mfc
        state: 'off'
      #- condition: sun
      #  # before_offset: "+02:00:00"  ==> Horario Invierno GMT+1, en el amanecer -2h
      #  # before_offset: "+00:30:00" ==> Horario Verano GMT+2, el amanecer -30m
      #  before: sunrise
      #  before_offset: "+02:00:00" # Horario Invierno GMT+1, en el amanecer +60m
  action:
    #- service: scene.turn_on
    #  target:
    #    entity_id: scene.dormitorio_relax
    - service: light.turn_on
      entity_id: 
        - light.luces_dormitorio_mfc
        - light.esphome_s20_sw1_led
    - service: input_text.set_value
      data:
        value: "sensor turn_on light.luces_dormitorio"
      target:
        entity_id: input_text.helper_hue_dimmer_switch_dormitorio
    # Espera de 5'
    - delay: '00:10:00'
    # Luces Off + Led
    - service: light.turn_off
      entity_id: 
        - light.luces_dormitorio
        - light.esphome_s20_sw1_led
    - service: input_text.set_value
      data:
        value: "sensor turn_off light.luces_dormitorio"
      target:
        entity_id: input_text.helper_hue_dimmer_switch_dormitorio

- id: L09
  alias: 'L09 Luces On Pasillo Según Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.hue_movimiento_pasillo_presencia
      to: 'on'
  condition:
    condition: and
    conditions:
      #  # after_offset: "-02:00:00"  ==> Horario Invierno GMT+1, en el amanecer -2h
      #  # after_offset: "-00:30:00" ==> Horario Verano GMT+2, el amanecer -30m
      #- condition: sun
      #  after: sunset
      #  after_offset: "-02:00:00"
      - condition: template
        value_template: "{{ (now().hour >= 0 and now().hour < 11) or (now().hour > 17 and now().hour <= 23) }}"
      - condition: numeric_state
        entity_id: sensor.hue_movimiento_pasillo_luminosidad
        below: 4
      - condition: state
        entity_id: light.luz_pasillo
        state: 'off'
  action:
    - service: light.turn_on
      data:
        brightness_pct: >
          {% if now().hour >= 0 and now().hour <= 7 %} 10
          {% elif now().hour >= 8 and now().hour <= 17 %} 40
          {% else %} 50
          {% endif %}
      target:
        entity_id: light.luz_pasillo
    # Espera de 5'
    - delay:
        minutes: >
          {% if now().hour >= 1 and now().hour <= 7 %} 1
          {% else %} 3
          {% endif %}
    # Luces Off + Led
    - service: light.turn_off
      entity_id: 
        - light.luz_pasillo

- id: L10
  alias: 'L10 Luces On Estudio Según Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_movimiento_estudio
      to: 'on'
  condition:
    - condition: state
      entity_id: light.luz_estudio
      state: 'off'
    - condition: or
      conditions:
        - condition: sun
          after: sunset
          after_offset: "+00:30:00"
        - condition: sun
          # before_offset: "+00:30:00"  ==> Horario Invierno GMT+1, en el amanecer -30m
          # before_offset: "+01:30:00" ==> Horario Verano GMT+2, el amanecer 1h-30m
          before: sunrise
          before_offset: "+00:30:00"
        # https://www.home-assistant.io/docs/scripts/conditions/
        #
        # si el sensor de luz está es < 3 lumx
        #- condition: numeric_state
        #  entity_id: sensor.illumination_158d0001e464a6
        #  below: 2
        # 'when dark' condition: either after sunset or before sunrise
  action:
    # Luces On
    - service: light.turn_on
      entity_id:
        - light.luz_estudio_techo
    #- service: scene.turn_on
    #  target:
    #    entity_id: scene.estudio_hall
    #  data:
    #    transition: 3
    # Espera de 5'
    - delay:
        minutes: >
          {% if now().hour >= 1 and now().hour <= 7 %} 1
          {% else %} 5
          {% endif %}
    # Luces Off + Led
    - service: light.turn_off
      entity_id: 
        - light.luz_estudio_techo

- id: L11
  alias: 'L11 Luces On Armario Estudio Sensor'
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_puerta_estudio_armario
  action:
    - choose:
      # IF puerta cerrada => apaga Luz siempre
      - conditions:
        - condition: state
          entity_id: binary_sensor.aqara_puerta_estudio_armario
          state: 'off' # CERRADO
        sequence:
          - service: light.turn_off
            entity_id: 
              - light.luz_estudio_armario
              - light.esphome_s26_sw1_led
      #ELSE puerta abierta
      default:
        - service: light.turn_on
          entity_id: 
            - light.luz_estudio_armario
            - light.esphome_s26_sw1_led


#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS CONTROL BOTONES ESPHOME                                              #
#                                                                             #
#-----------------------------------------------------------------------------#

#
# ESPHOME 4CH SW1 - LUCES JARDIN
#
- id: S01_4CH_SW1
  alias: 'S01 Sonoff 4CH SW1 Boton1 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw1_button_1
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw1_relay_1

- id: S02_4CH_SW1
  alias: 'S02 Sonoff 4CH SW1 Boton2 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw1_button_2
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw1_relay_2

- id: S03_4CH_SW1
  alias: 'S03 Sonoff 4CH SW1 Boton3 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw1_button_3
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw1_relay_3

- id: S04_4CH_SW1
  alias: 'S04 Sonoff 4CH SW1 Boton4 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw1_button_4
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw1_relay_4

#
# ESPHOME 4CH SW2 -  RIEGO PLANTAS y BONSAIS
#
- id: S01_4CH_SW2
  alias: 'S01 Sonoff 4CH SW2 Boton1 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw2_button_1
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw2_relay_1

- id: S02_4CH_SW2
  alias: 'S02 Sonoff 4CH SW2 Boton2 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw2_button_2
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw2_relay_2

- id: S03_4CH_SW2
  alias: 'S03 Sonoff 4CH SW2 Boton3 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw2_button_3
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw2_relay_3

- id: S04_4CH_SW2
  alias: 'S03 Sonoff 4CH SW2 Boton4 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw2_button_4
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw2_relay_4

#
# ESPHOME 4CH SW3 -  RIEGO CESPED
#
- id: S01_4CH_SW3
  alias: 'S01 Sonoff 4CH SW3 Boton1 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw3_button_1
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw3_relay_1

- id: S02_4CH_SW3
  alias: 'S02 Sonoff 4CH SW3 Boton2 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw3_button_2
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw3_relay_2

- id: S03_4CH_SW3
  alias: 'S01 Sonoff 4CH SW3 Boton3 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw3_button_3
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw3_relay_3

- id: S04_4CH_SW3
  alias: 'S03 Sonoff 4CH SW3 Boton4 On'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw3_button_4
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_4ch_sw3_relay_4

#
# ESPHOME POW - DEPURADORA PISCINA
#
- id: S06
  alias: 'S06 Timer Piscina Depuradora Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.piscina_depuradora_ch0_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.piscina_interruptor_global
        state: 'on'
      - condition: state
        entity_id: binary_sensor.piscina_depuradora_ch0_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
      - condition: template
        value_template: "{{ states('person.paloma') != 'home' }}"
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.piscina_depuradora_ch0
        duration: '{{ states.sensor.piscina_depuradora_ch0_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw3

- id: S06b
  alias: 'S06b Timer Piscinda Depuradora Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.piscina_depuradora_ch0_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.piscina_interruptor_global  # Interruptor General Piscina
        state: 'on'
      - condition: state
        entity_id: binary_sensor.piscina_depuradora_ch0_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.piscina_depuradora_ch0
        duration: '{{ states.sensor.piscina_depuradora_ch0_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw3

- id: S06c
  alias: 'S06c Timer Piscina Depuradora CH0 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.piscina_depuradora_ch0
  action:
    - service: script.piscina_depuradora_ch0_timer_cancel


# ESPHOME S20 - SW1 Smart Plug Dormitorio Principal
#

- id: S09
  alias: 'S09 Sonoff S20 SW1 Toggle'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_s20_sw1_boton
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_s20_sw1

- id: S09b
  alias: 'S09b Sonoff S20 SW3 Toggle'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_s20_sw3_boton
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_s20_sw3

- id: S10
  alias: 'S10 Switch Dormitorio MFC On'
  trigger:
    - platform: sun
      # offset: "+02:30:00"   # Horario Invierno GMT+2  => 18:30 + 3:30 = 22:00
      # offset: "+00:30:00"   # Horario Verano GMT+1  => 21:30 + 0:30 = 22:00
      event: sunset
      # MODO VERANO => MOSQUITOS
      offset: "+00:30:00"
    #- platform: time # Solo Invierno Calefacción
    #  at: '06:45:00'
    #- platform: sun  # solo para calefacción
    #  event: sunrise
    #  offset: "-02:00:00"
  condition:
    condition: and
    conditions:
      # Hay alguien en casa
      - condition: state
        entity_id: input_boolean.calefac_programador_mfc
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_mfc
        state: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.esphome_s20_sw1

- id: S10b
  alias: 'S10b Switch Dormitorio PAF On'
  trigger:
    - platform: sun
      # offset: "+02:30:00"   # Horario Invierno GMT+1  => 18:30 + 3:30 = 22:00
      # offset: "+00:30:00"   # Horario Verano GMT+2  => 21:30 + 0:30 = 22:00
      event: sunset
      # MODO VERANO => MOSQUITOS
      offset: "+00:30:00"
  condition:
    condition: and
    conditions:
      # Hay alguien en casa
      - condition: state
        entity_id: input_boolean.calefac_programador_paf
        state: 'on'
      - condition: state
        entity_id: input_boolean.family_sleep_home_paf
        state: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.esphome_s20_sw3

#- id: S10c
#  alias: 'S10c Switch Dormitorio AAF On'
#  trigger:
#    - platform: sun
#      # offset: "+02:30:00"   # Horario Invierno GMT+1  => 18:30 + 3:30 = 22:00
#      # offset: "+00:30:00"   # Horario Verano GMT+2  => 21:30 + 0:30 = 22:00
#      event: sunset
#      offset: "+02:30:00"
#  condition:
#    condition: and
#    conditions:
#      # Hay alguien en casa
#      - condition: state
#        entity_id: input_boolean.calefac_programador_aaf
#        state: 'on'
#      - condition: state
#        entity_id: input_boolean.family_sleep_home_aaf
#        state: 'on'
#  action:
#    - service: switch.turn_on
#      entity_id: switch.sonoff_S26_sw1

- id: S12
  alias: 'S12 Switch Dormitorios Off'
  trigger:
    #- platform: time # Solo Invierno Calefacción
    #  at: 
    #    - "00:00:00"
    #    - "01:00:00"
    #    - "02:00:00"
    #    - "03:00:00"
    #    - "04:00:00"
    - platform: sun
      event: sunrise
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: switch.esphome_s20_sw1
        state: 'on'
      - condition: state
        entity_id: switch.esphome_s20_sw3
        state: 'on'
  action:
    - service: switch.turn_off
      entity_id: 
        - switch.esphome_s20_sw1
        - switch.esphome_s20_sw3

#
# SAI RACK COMUNICACIONES
#
#- id: S15
#  alias: 'S15 ups apc700 status'
#  trigger:
#    - platform: state
#      entity_id: binary_sensor.ups_status
#      from: 'on'
#      to: 'off'
#      for: '00:00:10'
#  action:
#    # Script Notificación Alarma
#    - service: script.notifica_alarma
#      data:
#        voz: 'Fallo Eléctrico. Cuadro rack estudio sin corriente eléctrica'
#        titulo: '*AVISO FALLO ELECTRICO*'
#        mensaje: >
#          >>> URGENTE: SAI RACK COMUNICACIONES SIN CORRIENTE

#
# ESPHOME POW R2 SW2 - LAVADORA
#
- id: S16
  alias: 'S16 Sonoff POW Lavadora Boton Switch on'
  trigger:
    platform: state
    entity_id: binary_sensor.esphome_pow_sw2_boton
    from: 'off'
    to: 'on'
    for: '00:00:02'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_pow_sw2

- id: S16b
  alias: 'S16b Sonoff POW Lavadora Led'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_pow_sw2_lavadora_lavando
  action:
    - service: light.toggle
      target:
        entity_id: light.esphome_pow_sw2_led

- id: S16c
  alias: 'Auto-Apagado Warning Lavadora (S16c)'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_pow_sw2_lavadora_warning
      from: 'off'
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_warning.last_changed) - as_timestamp(states.binary_sensor.esphome_pow_sw2_lavadora_lavando.last_changed) < 300 }}"
  action:
    - service: input_datetime.set_datetime
      entity_id: input_datetime.lavadora_fin_lavado
      data:
        time: '{{ now().strftime("%H:%M:%S") }}'
    # Llama al script de apagado de Sonoof POW si viene de un lavado
    - service: script.lavadora_switch_off

- id: S16d
  alias: 'S16d Lavadora Hora Inicio'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_pow_sw2_lavadora_lavando
      from: 'off'
      to: 'on'
  action:
    - service: input_datetime.set_datetime
      entity_id: input_datetime.lavadora_inicio_lavado
      data:
        time: '{{ now().strftime("%H:%M") }}'
    - service: input_datetime.set_datetime
      entity_id: input_datetime.lavadora_fin_lavado
      data:
        time: '00:00'

#
# ESPHOME 4CH-R2 SW2 RIEGO BONSAIS
#
# https://community.home-assistant.io/t/timer-execute-and-action-from-lovelace-ui/123512
# https://community.home-assistant.io/t/lovelace-irrigation-card-help-needed/67667/2
#
# Sensores para Status Programador Activo on/off
  # - binary_sensor.riego_control_bomba_status
  # - binary_sensor.riego_bonsais_ch1_dia_ejecucion
  # - binary_sensor.riego_bonsais_ch2_dia_ejecucion
  # - binary_sensor.riego_tomates_ch0_dia_ejecucion
  # - binary_sensor.riego_bonsais_dia_ejecucion

# Sensores para Status Control Riego Activo on/off  (regando ahora?)
  # - binary_sensor.riego_bonsais_ch1_status
  # - binary_sensor.riego_bonsais_ch2_status
  # - binary_sensor.riego_tomates_ch0_status
  # - binary_sensor.riego_bonsais_status
#
# Regla Diaria cada 8 horas
# Control del Interruptor General de Riego en base a Previsión Tiempo
# SENSOR:  input_boolean.riego_interruptor_global
#
- id: S18
  alias: 'S18 Control Interruptor General Riego'
  mode: restart
  trigger:
    - platform: time
      at:
        - '07:00:00'
        - '21:00:00'
  action:
    - choose:
        # IF Riego On AND HOY No Se Riega (Llueve) => Apaga Riego
        - conditions:
          - condition: template
            value_template: "{{ is_state('input_boolean.riego_interruptor_global','on') and is_state('binary_sensor.riego_automatico_hoy','off') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.riego_interruptor_global
        # ELIF Riego Off AND HOY  Se Riega (No Llueve) => Enciende Riego
        - conditions:
          - condition: template
            value_template: "{{ is_state('input_boolean.riego_interruptor_global','off') and is_state('binary_sensor.riego_automatico_hoy','on') }}"
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.riego_interruptor_global

#
# ESPHOME POW R2 SW4 - BOMBA POZO
#

#
# Regla para encender/apagar el controlador de la bomba de riego del cesped en función del interruptor general de riego
#
# SENSOR:  input_boolean.riego_interruptor_global
#
# PLAN DE RIEGOS ESTACION OTOÑO /VERANO
#
#     CANAL   SECTOR    HORA    TRAMO1    HORA2     TRAMO2
#     A       1         8:00    5         21:00     4
#     B       2         10:50   4         23:00     4
#     C       3         12:00   4         01:00     4
#
- id: S18b
  alias: 'S18b Control Bomba Riego'
  mode: restart
  trigger:
    - platform: homeassistant
      event: start
    - platform: time
      at:
        - '07:55:00'  # Enciende
        - '12:30:00'  # Apaga
        - '20:55:00'  # Enciente
        - '01:30:00'  # Apaga
  action:
    # Apaga la bomba de riego por las noches y la enciende a primera hora en función del estado del interruptor global
    - choose:
        # IF el interruptor general riego está encendido => a las 01:30 y a las 12:30, apaga la bomba de riego
        - conditions:
          - condition: template
            value_template: "{{ now().hour == 12 or now().hour == 1 }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.esphome_pow_sw4
        # ELIF
        - conditions:
          - condition: template
            value_template: "{{ (now().hour == 7 or now().hour == 20) and is_state('input_boolean.riego_interruptor_global','on')}}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.esphome_pow_sw4

# Regla Original Control Bomba Riego basado en el interruptor global
#
#- id: S18b
#  alias: 'S18b Control Bomba Riego'
#  mode: restart
#  trigger:
#    - platform: state
#      entity_id: input_boolean.riego_interruptor_global
#  action:
#    # Apaga/Enciende el controlador de la bomba de riego en función del interruptor
#    - choose:
#        # IF el interruptor general riego se enciende => enciende controlador bomba
#        - conditions:
#          - condition: template
#            value_template: "{{ is_state('input_boolean.riego_interruptor_global','on') and is_state('binary_sensor.riego_control_bomba_status','off') }}"
#          sequence:
#            - service: switch.turn_on
#             target:
#                entity_id: switch.esphome_pow_sw4
#        # ELIF el interruptor general riego se apaga y el controlador bomba riego encendido => Apaga controlador bomba
#        - conditions:
#          - condition: template
#            value_template: "{{ is_state('input_boolean.riego_interruptor_global','off') and is_state('binary_sensor.riego_control_bomba_status','on') }}"
#          sequence:
#            - service: switch.turn_off
#              target:
#                entity_id: switch.esphome_pow_sw4
#
#
- id: S19
  alias: 'S19 Set Luvia Ayer'
  mode: restart
  trigger:
    - platform: time
      at:
        - '23:59:00'
  action:
    - service: input_text.set_value
      data_template:
        entity_id: input_text.riego_prevision_lluvia_ayer
        value: "{{ states('sensor.dark_sky_icon') }}"

- id: S19b
  alias: 'S19b Sonoff POW SW4 Boton'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_pow_sw4_boton
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.esphome_pow_sw4
#
# ESPHOME 4CH-R2 SW2 RIEGO : Relay1 BONSAIS TOP
#
- id: S19c
  alias: 'S19c Timer Riego CH1 Bonsais Top Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch1_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch1_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch1
        duration: '{{ states.sensor.riego_bonsais_ch1_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw2_relay_1

- id: S19d
  alias: 'S19d Timer Riego CH1 Bonsais Top Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch1_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch1_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch1
        duration: '{{ states.sensor.riego_bonsais_ch1_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw2_relay_1

- id: S19e
  alias: 'S19e Timer Riego CH1 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_bonsais_ch1
  action:
    - service: script.riego_bonsais_ch1_timer_cancel

#
# ESPHOME 4CH-R2 SW2 RIEGO : Relay2 PLANTAS ENTRADA
#
- id: S20
  alias: 'S20 Timer Riego CH2 Plantas Aromaticas Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch2_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch2_dia_ejecucion_t1  # Sensor que indica si es día de ejecución en función de la lista input_select.riego_bonsais_ch1_programador_dias
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch2
        duration: '{{ states.sensor.riego_bonsais_ch2_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw2_relay_2

- id: S20b
  alias: 'S20b Timer Riego CH2 Plantas Aromaticas Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch2_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch2_dia_ejecucion_t2  # Sensor que indica si es día de ejecución en función de la lista input_select.riego_bonsais_ch1_programador_dias
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch2
        duration: '{{ states.sensor.riego_bonsais_ch2_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw2_relay_2

- id: S20c
  alias: 'S20c Timer Riego CH2 Plantas Aromaticas Tramo1'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_bonsais_ch2
  action:
    - service: script.riego_bonsais_ch2_timer_cancel

#
# ESPHOME 4CH-R2 SW2 RIEGO : Relay3 FUENTE ZEN
#
- id: S23
  alias: 'S23 Timer Fuente CH3 Fuente Zen Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch3_start_time.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch3_dia_ejecucion  # Sensor que indica si es día de ejecución en función de la lista input_select.riego_bonsais_ch1_programador_dias
        state: 'on'
  action:
    # Timer Programador Automático
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch3
        duration: '{{ states.sensor.riego_bonsais_ch3_duracion_planificada.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw2_relay_3

- id: S24
  alias: 'S24 Timer Fuente CH3 Fuente Zen End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_bonsais_ch3
  action:
    - service: script.riego_bonsais_ch3_timer_cancel

#
# ESPHOME BAS SW1 RIEGO : BONSAIS PRODUCCION
#
- id: S25
  alias: 'S25 Timer Riego Bonsais Produccion Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch0_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch0_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Automático
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch0
        duration: '{{ states.sensor.riego_bonsais_ch0_duracion_planificada_t1.state|int * 60 }}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw1

- id: S26
  alias: 'S26 Timer Riego Bonsais Produccion Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_bonsais_ch0_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_bonsais_ch0_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Automático
    - service: timer.start
      data_template:
        entity_id: timer.riego_bonsais_ch0
        duration: '{{ states.sensor.riego_bonsais_ch0_duracion_planificada_t2.state|int * 60 }}'
    - service: switch.turn_on
      entity_id: switch.esphome_pow_sw1

- id: S27
  alias: 'S27 Timer Riego Bonsais Produccion End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_bonsais_ch0
  action:
    - service: script.riego_bonsais_ch0_timer_cancel

#
# ESPHOME POW SW1 : RIEGO HUERTO TOMATERA
#
- id: S28
  alias: 'S28 Timer Riego Huerto Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_tomates_ch0_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_tomates_ch0_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Automático
    - service: timer.start
      data_template:
        entity_id: timer.riego_tomates_ch0
        duration: '{{ states.sensor.riego_tomates_ch0_duracion_planificada_t1.state|int * 60 }}'
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw2
      
- id: S29
  alias: 'S29 Timer Riego Huerto Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_tomates_ch0_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_tomates_ch0_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Automático
    - service: timer.start
      data_template:
        entity_id: timer.riego_tomates_ch0
        duration: '{{ states.sensor.riego_tomates_ch0_duracion_planificada_t2.state|int * 60 }}'
    - service: switch.turn_on
      entity_id: switch.esphome_bas_sw2

- id: S30
  alias: 'S30 Timer Riego Huerto End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_tomates_ch0
  action:
    - service: script.riego_tomates_ch0_timer_cancel

#
# ESPHOME 4CH-R2 SW3 RIEGO CESPED CH1
#
- id: S31
  alias: 'S31 Timer Riego Cesped CH1 Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch1_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch1_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch1
        duration: '{{ states.sensor.riego_cesped_ch1_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_1

- id: S31b
  alias: 'S31b Timer Riego Cesped CH1 Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch1_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch1_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch1
        duration: '{{ states.sensor.riego_cesped_ch1_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_1

- id: S31c
  alias: 'S31c Timer Riego Cesped CH1 Tramo3'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch1_start_time_t3.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch1_dia_ejecucion_t3  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch1
        duration: '{{ states.sensor.riego_cesped_ch1_duracion_planificada_t3.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_1

- id: S31z
  alias: 'S31z Timer Riego Cesped CH1 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_cesped_ch1
  action:
    - service: script.riego_cesped_ch1_timer_cancel

#
# ESPHOME 4CH-R2 SW3 RIEGO CESPED CH2
#
- id: S32
  alias: 'S32 Timer Riego Cesped CH2 Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch2_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch2_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch2
        duration: '{{ states.sensor.riego_cesped_ch2_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_2

- id: S32b
  alias: 'S32b Timer Riego Cesped CH2 Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch2_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch2_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch2
        duration: '{{ states.sensor.riego_cesped_ch2_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_2

- id: S32c
  alias: 'S32c Timer Riego Cesped CH2 Tramo3'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch2_start_time_t3.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch2_dia_ejecucion_t3  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch2
        duration: '{{ states.sensor.riego_cesped_ch2_duracion_planificada_t3.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_2

- id: S32z
  alias: 'S31z Timer Riego Cesped CH2 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_cesped_ch2
  action:
    - service: script.riego_cesped_ch2_timer_cancel

#
# ESPHOME 4CH-R2 SW3 RIEGO CESPED CH3
#
- id: S33
  alias: 'S33 Timer Riego Cesped ch3 Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch3_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch3_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch3
        duration: '{{ states.sensor.riego_cesped_ch3_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_3

- id: S33b
  alias: 'S33b Timer Riego Cesped CH3 Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch3_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch3_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch3
        duration: '{{ states.sensor.riego_cesped_ch3_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_3

- id: S33c
  alias: 'S33c Timer Riego Cesped ch3 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_cesped_ch3
  action:
    - service: script.riego_cesped_ch3_timer_cancel

#
# ESPHOME 4CH-R2 SW3 RIEGO CESPED CH4
#
- id: S34
  alias: 'S34 Timer Riego Cesped CH4 Tramo1'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch4_start_time_t1.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch4_dia_ejecucion_t1  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch4
        duration: '{{ states.sensor.riego_cesped_ch4_duracion_planificada_t1.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_4

- id: S34b
  alias: 'S34b Timer Riego Cesped CH4 Tramo2'
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.riego_cesped_ch4_start_time_t2.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.riego_interruptor_global  # Interruptor General Riego segun Forecast Tiempo
        state: 'on'
      - condition: state
        entity_id: binary_sensor.riego_cesped_ch4_dia_ejecucion_t2  # Sensor del programador on/off
        state: 'on'
  action:
    # Timer Programador Diario
    - service: timer.start
      data_template:
        entity_id: timer.riego_cesped_ch4
        duration: '{{ states.sensor.riego_cesped_ch4_duracion_planificada_t2.state|int * 60}}'
    - service: switch.turn_on
      entity_id: switch.esphome_4ch_sw3_relay_4

- id: S34c
  alias: 'S34c Timer Riego Cesped CH4 End'
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.riego_cesped_ch4
  action:
    - service: script.riego_cesped_ch4_timer_cancel

- id: S40
  alias: 'S40 Control Jardin Sobreriego'
  trigger:
    - platform: state
      entity_id:
        - switch.esphome_4ch_sw2_relay_1
        - switch.esphome_4ch_sw2_relay_2
        - switch.esphome_4ch_sw2_relay_3
        - switch.esphome_4ch_sw2_relay_4
        - switch.esphome_4ch_sw3_relay_1
        - switch.esphome_4ch_sw3_relay_2
        - switch.esphome_4ch_sw3_relay_3
        - switch.esphome_4ch_sw3_relay_4
      to: 'on'
      for: '00:12:01'
  action:
    - service: script.jardin_riego_off
    # Notifica a Familia
    - service: script.notifica_evento
      data:
        titulo: '*JARDIN: SOBRERIEGO DETECTADO*'
        mensaje: >
          >>> EVENTO: Control Riego/Fuentes encendidas > 10'
          >>> JARDIN: Apagado total del riego

#- id: S42
#  alias: 'S42 Switch Desk Power On'
#  trigger:
#    - platform: time
#      at: "08:00:00"
#  action:
#    - service: switch.turn_on
#      entity_id: switch.esphome_bas_sw3

- id: S43
  alias: 'S43 Control Depuradora Piscina'
  trigger:
    - platform: state
      entity_id: binary_sensor.piscina_depuradora_ch0_motor_on
      to: 'on'
      for: '05:00:00'
  action:
    - service: script.piscina_depuradora_off
    # Notifica a Familia
    - service: script.notifica_evento
      data:
        titulo: '*PISCINA: SOBRE-DEPURACION DETECTADO*'
        mensaje: >
          >>> EVENTO: Control Motor Depuradora Piscina > 5h'
          >>> PISCINA: Apagado depuradora piscina

#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE CONTROL DE PING DEVICES BINARY SENSOR                             #
#                                                                             #
#-----------------------------------------------------------------------------#

#
# ping_01_router_fibra_movistar:
#
- id: P01
  alias: 'P01_Test_Conectividad_Ping_Router'
  trigger:
    - platform: state
      entity_id: binary_sensor.ping_00_wan_internet_google
      from: 'on'
      to: 'off'
      for: '00:01:00'
  condition:
    - condition: state
      entity_id: input_boolean.alarm_ping_conectivity
      state: 'on'
  action:
    # Script Notificación Alarma
    - service: script.notifica_alarma
      data:
        voz: 'Alarma Conexión de Red (ping)'
        titulo: '*AVISO CONECTIVIDAD PING*'
        mensaje: >
          >>> URGENTE: Fallo en conectividad de red (ping)

          >>> DISPOSITIVO: WAN ROUTER MOVISTAR
#
#ping_05_router_wifi_tplink:
#
- id: P02
  alias: 'P02_Test_Conectividad_Ping_WIFI_TPlink'
  trigger:
    - platform: state
      entity_id: binary_sensor.ping_05_router_wifi_tplink
      from: 'on'
      to: 'off'
      for: '00:05:00'
  condition:
    - condition: state
      entity_id: input_boolean.alarm_ping_conectivity
      state: 'on'
  action:
    # Script Notificación Alarma
    - service: script.notifica_alarma
      data:
        voz: 'Alarma Conexión de Red (ping)'
        titulo: '*AVISO CONECTIVIDAD PING*'
        mensaje: >
          >>> URGENTE: Fallo en conectividad de red (ping)

          >>> DISPOSITIVO: AP WIFI TPLINK

- id: P03
  alias: 'P03_Test_Conectividad_Ping_Sonoff_4CH_Status'
  trigger:
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw1_status
      from: 'on'
      to: 'off'
      for: '00:05:00'
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw2_status
      from: 'on'
      to: 'off'
      for: '00:05:00'
    - platform: state
      entity_id: binary_sensor.esphome_4ch_sw3_status
      from: 'on'
      to: 'off'
      for: '00:05:00'
    - platform: state
      entity_id: binary_sensor.esphome_pow_sw3_status # POW SW3 PISCINA
      from: 'on'
      to: 'off'
      for: '00:05:00'
  condition:
    - condition: state
      entity_id: input_boolean.alarm_ping_conectivity
      state: 'on'
  action:
    # Script Notificación Alarma
    - service: input_text.set_value
      entity_id: input_text.alarm_trigger
      data_template:
        value: "{{ trigger.to_state.attributes.friendly_name }}"
    - service: script.notifica_alarma
      data:
        voz: 'Alarma Conexión de Red (ping)'
        titulo: '*AVISO CONECTIVIDAD PING*'
        mensaje: >
          >>> URGENTE: Fallo en conectividad de red (ping)

          >>> DISPOSITIVO: {{ states('input_text.alarm_trigger') }}


#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE AUTOMATIZACION CON TAGS NFC                                       #
#                                                                             #
#-----------------------------------------------------------------------------#

# Comprueba si el Tag Reader tiene apagado el led verde y sonido cuando lee un tag, para activarlo siempre.
- id: T00
  alias: 'Tagreader Check Led'
  trigger:
    - platform: state
      entity_id: switch.tagreader_9a0be4_buzzer_enabled
      to: 'off'
    - platform: state
      entity_id: switch.tagreader_9a0be4_led_enabled
      to: 'off'
  action:
    - service: switch.turn_on
      data:
        entity_id: 
          - switch.tagreader_9a0be4_buzzer_enabled
          - switch.tagreader_9a0be4_led_enabled

- id: T01
  alias: 'NFC AAC Tag1 Alarma '
  trigger:
    - platform: tag
      tag_id: 04-50-B6-01-25-3B-03 # AAC Blue Tag
    - platform: tag
      tag_id: 04-50-4F-01-B5-1D-03 # MFC Red Tag
    - platform: tag
      tag_id: 04-50-9A-01-7D-1D-03 # AAF Black Tag
    - platform: tag
      tag_id: 04-50-B3-01-0D-3B-03 # PAF Yellow Tag
  action:
    - choose:
      # IF Alarma Homy = Desarmada => Armado Away
      - conditions:
        - condition: state
          entity_id: alarm_control_panel.ha
          state: 'disarmed'
        sequence:
          # Check sensores perimetro
          - service: script.check_sensores_magneticos_perimetro
          # Armardo Away
          - service: alarm_control_panel.alarm_arm_away
            data:
              entity_id: alarm_control_panel.ha
              code: !secret alarm_control_code
      #ELSE alarma armado home/away => Desarmado
      default:
        # Check sensores perimetro
        - service: script.check_sensores_magneticos_perimetro
        # Desarmado
        - service: alarm_control_panel.alarm_disarm
          data:
            entity_id: alarm_control_panel.ha
            code: !secret alarm_control_code

- id: T02
  alias: 'NFC Tag Credit Card Botón Pánico'
  trigger:
    - platform: tag
      tag_id: 79-D5-0A-8F # Tag Credit Card
  action:
    # BOTON DEL PANICO: Secuencia Alexa ALARMA
    - service: input_boolean.turn_on
      entity_id: input_boolean.alarm_panic_button
    - service: script.alarma_boton_panico

- id: T03
  alias: 'NFC Home Big Blue Tag - Armado Away'
  trigger:
    - platform: tag
      tag_id: 2C-CA-F0-22
  action:
    - service: alarm_control_panel.alarm_arm_away
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code

- id: T04
  alias: 'NFC Green Tag TEST'
  mode: single
  trigger:
    - platform: tag
      tag_id: 6e6b6c52-631e-42ea-b576-59d024e4a698 # Green Tag
  action:
    - service: fan.toggle
      target:
        entity_id: fan.estudio
    - delay: "00:00:02"
    - service: input_text.set_value
      data:
        value: "Ventilador Estudio {{ states('fan.estudio') | upper }}"
      target:
        entity_id: input_text.helper_ikea_dimmer_switch_estudio


#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE AUTOMATIZACION ACCIONES IOS                                       #
#                                                                             #
#-----------------------------------------------------------------------------#
- id: I01
  alias: 'IOS Action Luz Salon'
  initial_state: true
  trigger:
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: 'luz_salon'
  action:
    # Salon
    - service: light.toggle
      target:
        entity_id: light.salon

- id: I02
  alias: 'IOS Action Luz Estudio'
  initial_state: true
  trigger:
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: 'luz_estudio'
  action:
    # Estudio
    - service: light.toggle
      target:
        entity_id: light.luces_estudio

- id: I03
  alias: 'IOS Action Alarma Off'
  initial_state: true
  trigger:
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: 'alarma_off'
  action:
    # Check sensores perimetro
    - service: script.check_sensores_magneticos_perimetro

    # Desarmado de Alarmas
    - service: alarm_control_panel.alarm_disarm
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code


- id: I04
  alias: 'IOS Action Alarma Away'
  initial_state: true
  trigger:
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: 'alarma_armado_total'
  action:
    # Desarmado de Alarmas
    - service: alarm_control_panel.alarm_arm_away
      data:
        entity_id: alarm_control_panel.ha
        code: !secret alarm_control_code

#-----------------------------------------------------------------------------#
#                                                                             #
# REGLAS DE AUTOMATIZACION DISPOSITIVOS ZIGBEE A TRAVES DE EVENTOS ZHA        #
#                                                                             #
#-----------------------------------------------------------------------------#

- id: ZHA_L1
  alias: ZHA Exterior Philips Hue Smart Button
  mode: queued
  # Realiza un ciclo cada vez que se pulsa en el boton up/down
  # scene.dormitorio_full, scene.dormitorio_lectura, scene.dormitorio_relax, scene.dormitorio_noche
  trigger:
    - device_id: 9b4a8d38607a9f81ccdffab704cd03e2
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: short_press
    - device_id: 9b4a8d38607a9f81ccdffab704cd03e2
      domain: zha
      platform: device
      type: remote_button_double_press
      subtype: turn_on
      id: double_press
    - device_id: 9b4a8d38607a9f81ccdffab704cd03e2
      domain: zha
      platform: device
      type: remote_button_triple_press
      subtype: turn_on
      id: triple_press
    - device_id: 9b4a8d38607a9f81ccdffab704cd03e2
      domain: zha
      platform: device
      type: remote_button_quadruple_press
      subtype: turn_on
      id: quadruple_press
  condition: []
  action:
    - choose:
        # IF trigger ID = short_press
        - conditions:
          - condition: trigger
            id: short_press
          sequence:
            # Enciende/Apaga Luz Exterior
            - service: light.toggle
              target:
                entity_id: light.luz_exterior
            - service: input_text.set_value
              data:
                value: "{{ trigger.id }} - light.luz_exterior {{ states('light.luz_exterior')}}"
              target:
                entity_id: input_text.helper_hue_smart_button_entrada
        # ELIF double_press
        - conditions:
          - condition: trigger
            id: double_press
          sequence:
            # Check Sensores Magneticos Perimetro
            - service: input_text.set_value
              data:
                value: "{{ trigger.id }} - check sensores perimetro"
              target:
                entity_id: input_text.helper_hue_smart_button_entrada
            # Ejecuta sript de chequeo de sensores perímetro principales
            - service: script.check_sensores_magneticos_perimetro
        # ELIF triple_press ==> ACTIVA BOTON PANICO DURANTE 5 MINUTOS
        - conditions:
          - condition: trigger
            id: triple_press
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.alarm_panic_button
            - service: script.alarma_boton_panico 
            - service: input_text.set_value
              data:
                value: "{{ trigger.id }} - BOTON DEL PANICO"
              target:
                entity_id: input_text.helper_hue_smart_button_entrada
            # Botón del pánico activado durante 5 minutos máximo
            - delay: "00:05:00"
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.alarm_panic_button

        # ELIF quadruple_press
        #- conditions:
        #  - condition: trigger
        #    id: quadruple_press
        #  sequence:

- id: ZHA_L2
  alias: ZHA Dormitorio MFC Philips HUE Dimmer
  mode: queued
  # Realiza un ciclo cada vez que se pulsa en el boton up/down
  # scene.dormitorio_full, scene.dormitorio_lectura, scene.dormitorio_relax, scene.dormitorio_noche
  #
  # Device: Hue Dimmer Switch
  # Event Type: remote_button_short_press, remote_button_double_press
  # Event Subtype: turn_on, turn_off, dim_up, dim_down
  #
  trigger:
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_double_press
      subtype: turn_on
      id: on_double_press
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_double_press
      subtype: turn_off
      id: off_double_press
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: dim_up
      id: dim_up
    - device_id: bef6e070a0c12e5234501e01092f27e8
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: dim_down
      id: dim_down
  condition: []
  action:
    # value: "{{ trigger.to_state.attributes.friendly_name }}"
    - choose:
        # IF trigger.id = on_short_press => Escena Dormitorio Lectura
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.dormitorio_lectura
            - service: input_text.set_value
              data:
                value: "scene.dormitorio_lectura"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio
        # ELIF on_double_press
        - conditions:
          - condition: trigger
            id: on_double_press
          sequence:
            # Enciende Luz Agustin y Apaga Luz Malen
            - service: light.turn_on
              target:
                entity_id: light.luz_dormitorio_agustin
            - service: light.turn_off
              target:
                entity_id: light.luz_dormitorio_malen
            - service: input_text.set_value
              data:
                value: "turn_on light.luz_agustin"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio
        # ELIF off_short_press
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            # Apaga Luz Agustin y Apaga Luz Malen
            - service: light.turn_off
              target:
                entity_id: light.luces_dormitorio_mfc
            - service: input_text.set_value
              data:
                value: "turn_off light.luces_dormitorio"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio
        # ELIF off_double_press
        - conditions:
          - condition: trigger
            id: off_double_press
          sequence:
            # Enciende Luz Malen y Apaga Luz Agustín
            - service: light.turn_on
              target:
                entity_id: light.luz_dormitorio_malen
            - service: light.turn_off
              target:
                entity_id: light.luz_dormitorio_agustin
            - service: input_text.set_value
              data:
                value: "turn_on light.luz_malen"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio
        # ELIF dim_up
        - conditions:
          - condition: trigger
            id: dim_up
          sequence:
            - service: input_select.select_next
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_dormitorio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_dormitorio')}}"
            - service: input_text.set_value
              data:
                value: "turn_on {{ states('input_select.helper_scene_dormitorio')}}"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio
        # ELIF dim_down
        - conditions:
          - condition: trigger
            id: dim_down
          sequence:
            - service: input_select.select_previous
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_dormitorio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_dormitorio')}}"
            - service: input_text.set_value
              data:
                value: "turn_on {{ states('input_select.helper_scene_dormitorio')}}"
              target:
                entity_id: input_text.helper_hue_dimmer_switch_dormitorio

- id: ZHA_L3
  alias: ZHA Cocina IKEA Rodret Dimmer
  mode: queued
  trigger:
    # trigger.id = 0 => on_press - turn_on
    # trigger.id = 1 => off_press - turn_off
    - platform: event
      event_type: zha_event
      event_data:
        device_id: 0a43ad4d68f6c171709761fb9a09e579
        command: 'off'
        cluster_id: 6
        endpoint_id: 1
      id: press-off
    - platform: event
      event_type: zha_event
      event_data:
        device_id: 0a43ad4d68f6c171709761fb9a09e579
        command: 'on'
        cluster_id: 6
        endpoint_id: 1
      id: press-on
  condition: []
  action:
    # value: "{{ trigger.to_state.attributes.friendly_name }}"
    - choose:
        # IF Trigger Short_Press - ON => TOGGLE Lavadora
        - conditions:
          - condition: trigger
            id: press-on
          sequence:
            - service: switch.toggle
              target:
                entity_id: switch.esphome_pow_sw2
        # IF Trigger Short_Press - OFF => TOGGLE Automation Warning Lavadora
        - conditions:
          - condition: trigger
            id: press-off
          sequence:
            - service: automation.toggle
              target:
                entity_id: automation.s16c_sonoff_pow_lavadora_warning

- id: ZHA_L4
  alias: ZHA Salon IKEA Styrbar Dimmer
  mode: queued
  # Realiza un ciclo cada vez que se pulsa en el boton left-right
  # scene.dormitorio_full, scene.dormitorio_lectura, scene.dormitorio_relax, scene.dormitorio_noche
  #
  # Event Type: remote_button_short_press, remote_button_double_press
  # Event Subtype: turn_on, turn_off, dim_up, dim_down
  #
  trigger:
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: left
      id: left
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: right
      id: right
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: dim_up
    - device_id: 3ec2d334b192909aca8ef449baa4dda0
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: dim_down
  condition: []
  # input_text.helper_ikea_dimmer_switch_salon
  action:
    - choose:
        # IF trigger.id = on_short_press
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.salon_noche
            - service: input_text.set_value
              data:
                value: "turn_on scene.salon_noche"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_salon
        # ELIF off_short_press
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.luces_salon
            - service: input_text.set_value
              data:
                value: "turn_off light.luces_salon"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_salon
        # ELIF left
        - conditions:
          - condition: trigger
            id: left
          sequence:
            - service: input_select.select_previous
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_salon
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_salon')}}"
            - service: input_text.set_value
              data:
                value: "turn_on {{ states('input_select.helper_scene_salon')}}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_salon
        # ELIF right
        - conditions:
          - condition: trigger
            id: right
          sequence:
            - service: input_select.select_next
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_salon
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_salon')}}"
            - service: input_text.set_value
              data:
                value: "turn_on {{ states('input_select.helper_scene_salon')}}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_salon

- id: ZHA_L5
  alias: ZHA Porche Jardin IKEA Tradfri
  mode: restart
  # Realiza un ciclo cada vez que se pulsa en el boton left-right
  # scene.dormitorio_full, scene.dormitorio_lectura, scene.dormitorio_relax, scene.dormitorio_noche
  #
  # Event Type: remote_button_short_press, remote_button_double_press
  # Event Subtype: turn_on, turn_off, dim_up, dim_down
  #
  trigger:
    - device_id: cadb122f52084f45d1708d4e91e2a0ce
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press # Trigger ID
    - device_id: cadb122f52084f45d1708d4e91e2a0ce
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: cadb122f52084f45d1708d4e91e2a0ce
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: dim_up
    - device_id: cadb122f52084f45d1708d4e91e2a0ce
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: dim_down
  condition: []
  action:
    - choose:
        # IF on_short_press => TOGGLE Luces Porche Jardín
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_porche_jardin
            - delay: "00:00:01"
            - service: input_text.set_value
              data:
                value: "light.luz_porche_jardin {{ states('light.luz_porche_jardin')}}"
              target:
                entity_id: input_text.helper_ikea_tradfri_switch_salon
        # ELIF off_short_press => TOGGLE Luces Jardin excepto Porche Jardín
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luces_jardin
            - delay: "00:00:01"
            - service: input_text.set_value
              data:
                value: "light.luces_jardin {{ states('light.luces_jardin')}}"
              target:
                entity_id: input_text.helper_ikea_tradfri_switch_salon
        # ELIF dim_up => TOGGLE Luces Exterior
        - conditions:
          - condition: trigger
            id: dim_up
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_exterior
            - delay: "00:00:01"
            - service: input_text.set_value
              data:
                value: "light.luces_jardin {{ states('light.luz_exterior')}}"
              target:
                entity_id: input_text.helper_ikea_tradfri_switch_salon
        # ELIF dim_down => TOGGLE Luces Piscina
        - conditions:
          - condition: trigger
            id: dim_down
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_piscina
            - delay: "00:00:01"
            - service: input_text.set_value
              data:
                value: "light.luz_piscina {{ states('light.luz_piscina')}}"
              target:
                entity_id: input_text.helper_ikea_tradfri_switch_salon

- id: ZHA_L6
  alias: ZHA Estudio IKEA Styrbar Dimmer
  mode: queued
  # Realiza un ciclo cada vez que se pulsa en el boton left-right
  # entity_id: scene.estudio_setup_soft, scene.estudio_setup_high, scene.estudio_azul, scene.estudio_ocre
  #
  # type: remote_button_short_press + subtype: dim_up => scene.estudio_azul
  # type: remote_button_short_press + subtype: dim_down => turn_off light.luz_estudio
  #
  # Control de las persianas:
  # type: remote_button_long_press + subtype: dim_down/up ==> open_cover / close_cover
  # type: remote_button_long_release + subtype: dim_down/up ==> stop_cover
  trigger:
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: left
      id: left
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: right
      id: right
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: lpress_dim_up
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: lpress_dim_down
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_long_release
      subtype: dim_up
      id: lrelease_dim_up
    - device_id: 328313c81613944986dbe5ef589bf2b6
      domain: zha
      platform: device
      type: remote_button_long_release
      subtype: dim_down
      id: lrelease_dim_down
  condition: []
  action:
    - choose:
        # IF trigger.id = on_short_press
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            # Selecciona la escena Setup_High (la segunda)
            - service: input_select.select_first
              data: {}
              target:
                entity_id: input_select.helper_scene_estudio
            - service: input_select.select_next
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_estudio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_estudio')}}"
            - service: input_text.set_value
              data:
                value: "{{ states('input_select.helper_scene_estudio') | lower }} ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF off_short_press
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.luz_estudio
            - service: input_text.set_value
              data:
                value: "Luz Estudio OFF"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF left
        - conditions:
          - condition: trigger
            id: left
          sequence:
            - service: input_select.select_previous
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_estudio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_estudio')}}"
            - service: input_text.set_value
              data:
                value: "{{ states('input_select.helper_scene_estudio') | lower }} ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF right
        - conditions:
          - condition: trigger
            id: right
          sequence:
            - service: input_select.select_next
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_estudio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_estudio')}}"
            - service: input_text.set_value
              data:
                value: "{{ states('input_select.helper_scene_estudio') | lower }} ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF lpress_dim_up
        - conditions:
          - condition: trigger
            id: lpress_dim_up
          sequence:
            - service: cover.open_cover
              target:
                entity_id: cover.persiana_estudio
            - service: input_text.set_value
              data:
                value: "Cover Estudio OPEN"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF lpress_dim_down
        - conditions:
          - condition: trigger
            id: lpress_dim_down
          sequence:
            - service: cover.close_cover
              target:
                entity_id: cover.persiana_estudio
            - service: input_text.set_value
              data:
                value: "Cover Estudio CLOSE"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF lrelease_dim_up
        - conditions:
          - condition: trigger
            id: lrelease_dim_up
          sequence:
            - service: cover.stop_cover
              target:
                entity_id: cover.persiana_estudio
            - service: input_text.set_value
              data:
                value: "Cover Estudio STOP"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio

        # ELIF lrelease_dim_down
        # NOTA: 
        # Con las pruebas realizadas, el botón de IKEA Remote Control Estudio, al soltar el boton Dim-DOWN (estrella pequeña) tras una pulsación larga,
        # genera por error el evento <Long Realease - Dim UP>, en lugar de Dim Down. 
        # Para el uso de las persianas no supone un problema ya que solo necesito un evento Long-Release para parar el motor.

- id: ZHA_L7
  alias: ZHA Estudio IKEA Tradfri
  mode: queued
  # Short_press ON  ==> Toggle Ventilador toogle
  # Short_press OFF ==> Toggle Luz Estudio Setup Soft / Off
  # Long_Press ON   ==> AA Estudio on 
  # Long_Press OFF  ==> AA Estudio off
  #
  trigger:
    - device_id: 7bfd253f74df460b6e04fd16678d5dfc
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press # ==> Toggle Ventilador toogle
    - device_id: 7bfd253f74df460b6e04fd16678d5dfc
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: 7bfd253f74df460b6e04fd16678d5dfc
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: dim_up
    - device_id: 7bfd253f74df460b6e04fd16678d5dfc
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: dim_down
  condition: []
  action:
    - choose:
        # IF trigger.id = on_short_press ==> Toggle Ventilador toogle
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: fan.toggle
              target:
                entity_id: fan.estudio
            - delay: "00:00:02"
            - service: input_text.set_value
              data:
                value: "Ventilador Estudio {{ states('fan.estudio') | upper }}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF off_short_press ==> OFF ESUDIO 
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            # Aviso apagando luces estudio izquierda solo
            - service: light.turn_off
              entity_id: light.luz_estudio_izquierda
            # Apaga luces estudio con retardo variable en función de la hora
            - service: light.turn_off
              entity_id: light.luz_estudio
              data:
                transition: >
                  {% if now().hour >= 0 and now().hour <= 7 %} 30
                  {% elif now().hour >= 8 and now().hour <= 18 %} 1
                  {% else %} 30
                  {% endif %}
              target:
                entity_id: light.luz_estudio
            # Para Ventilador Estudio
            - service: fan.turn_off
              data: {}
              target:
                entity_id: fan.estudio
            # Para Alexa Estudio 
            - service: media_player.media_pause
              target:
                entity_id: media_player.echo_alexa_estudio
        # ELIF dim_up
        - conditions:
          - condition: trigger
            id: dim_up
          sequence:
            - service: climate.turn_on
              data: {}
              target:
                entity_id: climate.aa_estudio
            - service: input_text.set_value
              data:
                value: "A/A Estudio {{ states('climate.aa_estudio')| upper }}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF dim_down
        - conditions:
          - condition: trigger
            id: dim_down
          sequence:
            - service: climate.turn_off
              data: {}
              target:
                entity_id: climate.aa_estudio
            - service: input_text.set_value
              data:
                value: "A/A Estudio {{ states('climate.aa_estudio')| upper }}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio

- id: ZHA_L8
  alias: ZHA IKEA Dormitorio AAF IKEA Tradfri
  mode: restart
  #
  # Event Type: remote_button_short_press, remote_button_double_press
  # Event Subtype: turn_on, turn_off, dim_up, dim_down
  #
  trigger:
    - device_id: 20684e813ecec36f420f36d00c206fbe
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press # Trigger ID
    - device_id: 20684e813ecec36f420f36d00c206fbe
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: 20684e813ecec36f420f36d00c206fbe
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: dim_up
    - device_id: 20684e813ecec36f420f36d00c206fbe
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: dim_down
  condition: []
  action:
    - choose:
        # IF on_short_press
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.led_mesa_agu
        # ELIF off_short_press 
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_mesilla_aaf
        # ELIF dim_up
        - conditions:
          - condition: trigger
            id: dim_up
          sequence:
            - service: fan.turn_on
              target:
                entity_id: fan.aire_acondicionado_agu
        # ELIF dim_down
        - conditions:
          - condition: trigger
            id: dim_down
          sequence:
            - service: fan.turn_off
              target:
                entity_id: fan.aire_acondicionado_agu

- id: ZHA_L9
  alias: ZHA Estudio Aqara Cube
  mode: queued
  # DEVICE_FLIPED ==> Realiza un ciclo cada vez que se pulsa en el boton left-right
  # entity_id: scene.estudio_setup_soft, scene.estudio_setup_high, scene.estudio_azul, scene.estudio_ocre
  #
  # type: device_shaken, subtype: turn_on   => ALARM DISARM
  # type: device_rotated,subtype: left      => Escena Estudio Setup Soft
  # type: device_rotated,subtype: right     => Escena Estudio Setup High
  # type: device_knocked,subtype: face_any  => Escena Estudio Lava Palaustre
  # type: device_flipped,subtype: face_any  => Ciclo Derecha Loop Escenas
  # type: device_slid,subtype: face_any     => 
  trigger:
    - device_id: d37e91591c751fdbc46064847d200cbc
      domain: zha
      platform: device
      type: device_shaken
      subtype: turn_on
      id: shaken
    - device_id: d37e91591c751fdbc46064847d200cbc
      domain: zha
      platform: device
      type: device_knocked
      subtype: face_any
      id: knocked
    - device_id: d37e91591c751fdbc46064847d200cbc
      domain: zha
      platform: device
      type: device_rotated
      subtype: left
      id: rotated_left
    - device_id: d37e91591c751fdbc46064847d200cbc
      domain: zha
      platform: device
      type: device_rotated
      subtype: right
      id: rotated_right
    - device_id: d37e91591c751fdbc46064847d200cbc
      domain: zha
      platform: device
      type: device_flipped
      subtype: face_any
      id: flipped
  condition: []
  action:
    - choose:
        # IF trigger.id = shaken => Alarm DISARM
        - conditions:
          - condition: trigger
            id: shaken
          sequence:
            # Desarmado de Alarmas
            - service: alarm_control_panel.alarm_disarm
              data:
                entity_id: alarm_control_panel.ha
                code: !secret alarm_control_code
            - service: input_text.set_value
              data:
                value: "ALARMA HOMY {{ states('alarm_control_panel.ha')| upper }}"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF trigger.id = rotated_left => Escena Estudio Setup SOFT
        - conditions:
          - condition: trigger
            id: rotated_left
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.estudio_setup_soft
              data:
                transition: 5
            - service: input_text.set_value
              data:
                value: "scene.estudio_setup_soft ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF trigger.id = rotated_left => Escena Estudio Setup HIGH
        - conditions:
          - condition: trigger
            id: rotated_right
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.estudio_setup_high
              data:
                transition: 5
            - service: input_text.set_value
              data:
                value: "scene.estudio_setup_high ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF trigger.id = flipped
        - conditions:
          - condition: trigger
            id: flipped
          sequence:
            - service: input_select.select_next
              data:
                cycle: true
              target:
                entity_id: input_select.helper_scene_estudio
            - service: scene.turn_on
              target:
                entity_id: "{{ states('input_select.helper_scene_estudio')}}"
            - service: input_text.set_value
              data:
                value: "{{ states('input_select.helper_scene_estudio') | lower }} ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
        # ELIF knocked => Escena Lava Palaustre.
        - conditions:
          - condition: trigger
            id: knocked
          sequence:
            # Aviso apagando luces estudio izquierda solo
            - service: light.turn_off
              entity_id: light.luz_estudio_izquierda
            - service: script.alexa_estudio_secuencia
              data_template:
                sonido: 'clock_01'
                repeticion: 1
                voz: "OK"
            - service: scene.turn_on
              target:
                entity_id: scene.estudio_lava_palaustre
              data:
                transition: 60
            - service: media_player.media_pause
              target:
                entity_id: media_player.echo_alexa_estudio
            - service: input_text.set_value
              data:
                value: "scene.estudio_lava_palaustre ON"
              target:
                entity_id: input_text.helper_ikea_dimmer_switch_estudio
            - service: script.alexa_estudio_secuencia
              data_template:
                sonido: 'clock_01'
                repeticion: 1
                voz: "Vale, Activo Lavando Palaustre. Que descanses."

- id: ZHA_L10
  alias: ZHA Dormitorio PAF IKEA Tradfri
  mode: restart
  #
  # Event Type: remote_button_short_press, remote_button_double_press
  # Event Subtype: turn_on, turn_off, dim_up, dim_down
  #
  trigger:
    - device_id: 79551b9db03e27203c7483398811e579
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_on
      id: on_short_press # Trigger ID
    - device_id: 79551b9db03e27203c7483398811e579
      domain: zha
      platform: device
      type: remote_button_short_press
      subtype: turn_off
      id: off_short_press
    - device_id: 79551b9db03e27203c7483398811e579
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_up
      id: dim_up
    - device_id: 79551b9db03e27203c7483398811e579
      domain: zha
      platform: device
      type: remote_button_long_press
      subtype: dim_down
      id: dim_down
  condition: []
  action:
    - choose:
        # IF on_short_press
        - conditions:
          - condition: trigger
            id: on_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_mesa_paf
        # ELIF off_short_press 
        - conditions:
          - condition: trigger
            id: off_short_press
          sequence:
            - service: light.toggle
              target:
                entity_id: light.luz_mesilla_paf
        # ELIF dim_up
        - conditions:
          - condition: trigger
            id: dim_up
          sequence:
            - service: light.turn_on
              data:
                brightness_step_pct: 25
              target:
                entity_id: light.luz_mesilla_paf
        # ELIF dim_down
        - conditions:
          - condition: trigger
            id: dim_down
          sequence:
            - service: light.turn_on
              data:
                brightness_step_pct: -25
              target:
                entity_id: light.luz_mesilla_paf
